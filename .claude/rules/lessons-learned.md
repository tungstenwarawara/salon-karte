# 教訓ログ

過去の障害・ミスから得た教訓。同じ失敗を繰り返さないためのリファレンス。

## デプロイ・マイグレーション
- 本番DBにマイグレーション未適用のままデプロイ → マージ前に適用確認必須 (2026-02-19)
- Supabase dashboardから直接適用しローカルファイル不在 → 全マイグレーションはローカルファイルで管理 (2026-02-19)

## RPC関数
- RPC関数にSET search_path未設定 → 必ず `SECURITY INVOKER` + `SET search_path = public` (2026-02-19)
- `CREATE OR REPLACE` でパラメータ数が異なるとオーバーロード発生、PostgRESTが300を返す → パラメータ変更時は旧シグネチャを `DROP FUNCTION` してから作成 (2026-02-22)

## カラム名・クエリ整合性
- `.select("description")` → 正しくは `memo`。ビルドでは検出不可（文字列型） (2026-02-21)
- `.select("total_price, skin_condition")` → 別テーブルのカラム名を誤指定。Supabaseは空配列を返すだけ (2026-02-21)
- 全クエリに `.eq("salon_id", salon.id)` 欠落 → ルールに明記済みだったが守られず (2026-02-21)
- **対策**: `python3 scripts/check-select-columns.sh` をコミット前に必ず実行

## コード品質
- records/new が1145行に膨張 → ファイルサイズ制限（ページ300行、コンポーネント200行） (2026-02-20)
- 不要な決済方法を計画に含めかけた → 実業務フローを確認してから計画 (2026-02-20)
- CLAUDE.mdに古い行数を記載し続けた → 静的行数記載を廃止し実測コマンド方式に移行 (2026-02-21)
- 計画ファイルが完了後も残り再実行しようとした → 計画完了時にファイル削除を必須化 (2026-02-21)

## エラーハンドリング
- `setError("登録に失敗しました")` と固定メッセージのみで実際のエラーを握りつぶした → 全エラーで `error.message` を表示 + console.error (2026-02-22)
